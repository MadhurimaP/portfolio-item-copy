<!DOCTYPE html>
<html>
<head>
    <title>portfolio-item-copy</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"table",columns:2},items:[{xtype:"label",text:"Copy To Project:",padding:"5px"},{id:"project-picker",xtype:"rallyprojectpicker",margin:"5px",model:"Project",field:"Name"},{xtype:"rallybutton",text:"Select Portfolio Item",margin:"5px",handler:function(){app.chooseItem()}},{id:"item-label",xtype:"label",margin:"5px",style:"font-weight:bold;",text:""},{id:"copy-button",xtype:"rallybutton",text:"Copy",margin:"5px",disabled:!0,handler:function(){app.performCopy()}},{id:"summary",xtype:"label",margin:"5px",style:"font-weight:bold;",text:""}],launch:function(){app=this},chooseItem:function(){Ext.create("Rally.ui.dialog.ChooserDialog",{artifactTypes:["PortfolioItem"],autoShow:!0,title:"Choose Item",listeners:{artifactChosen:function(selectedRecord){this.down("#item-label").setText(selectedRecord.get("Name")),this.down("#copy-button").setDisabled(!0),app.itemSelected(selectedRecord)},scope:this}})},itemSelected:function(root){var config={model:"PortfolioItem",fetch:!0,filters:[{property:"ObjectID",operator:"=",value:root.get("ObjectID")}]};async.map([config],app.wsapiQuery,function(err,results){var item=results[0][0];app.list=[],async.map([item],app.createList,function(err,results){app.models={},app.types=_.uniq(_.map(app.list,function(l){return l.get("_type")})),async.mapSeries(app.types,app.loadModel,function(err,results){_.each(app.types,function(t,i){app.models[t]=results[i]}),app.down("#summary").setText(app.list.length+" Items to be copied");var projectRef=app.down("#project-picker").getValue();null!==projectRef&&""!==projectRef&&app.down("#copy-button").setDisabled(!1)})})})},performCopy:function(){app.copyList={},app.projectRef=app.down("#project-picker").getValue(),async.mapSeries(app.list,app.copyItem,function(err,results){null===err?app.down("#summary").setText(results.length+" Items copied to "+results[0].get("FormattedID")):app.down("#summary").setText(err)})},copyItem:function(i,callback){var copy={Name:i.get("Name"),Workspace:i.get("Workspace")._ref,Description:encodeURI(i.get("Description")),Owner:null!==i.get("Owner")?i.get("Owner")._ref:null,Project:app.projectRef};copy=app.copyTypeSpecificFields(copy,i);var parentRef=app.parentRef(i);if(null!==parentRef){var mappedRef=app.copyList[parentRef.ref];_.isUndefined(mappedRef)||(copy[parentRef.type]=mappedRef)}var model=app.models[i.get("_type")];async.map([{model:model,copy:copy,source:i}],app.createItem,function(err,results){_.isUndefined(err)||_.isNull(err)?callback(null,results[0]):callback(err,null)})},copyTypeSpecificFields:function(copy,item){return"task"==item.get("_type").toLowerCase()?app.copyTaskFields(copy,item):"hierarchicalrequirement"==item.get("_type").toLowerCase()?app.copyTaskFields(copy,item):-1!==item.get("_type").toLowerCase().indexOf("portfolioitem")?app.copyPortfolioFields(copy,item):copy},copyPortfolioFields:function(copy,item){return copy},copyStoryFields:function(copy,item){return copy.ScheduleState=item.get("ScheduleState"),copy.PlanEstimate=item.get("PlanEstimate"),copy},copyTaskFields:function(copy,item){return copy.State=item.get("State"),copy.Estimate=item.get("Estimate"),copy.TaskIndex=item.get("TaskIndex"),copy.ToDo=item.get("ToDo"),copy.Actuals=item.get("Actuals"),copy},createItem:function(item,callback){var rec=Ext.create(item.model,item.copy);rec.save({callback:function(result,operation){operation.success===!0?(app.copyList[item.source.get("_ref")]=result.get("_ref"),app.down("#summary").setText("Created "+result.get("FormattedID")),callback(null,result)):(console.log("Error:",operation),callback("Create Error when copying "+item.copy.Name,null))}})},readCollection:function(collectionConfig,callback){collectionConfig.reference.getCollection(collectionConfig.type,{fetch:!0}).load({fetch:!0,callback:function(records,operation,success){callback(null,records)}})},createList:function(root,callback){var config={model:root.raw._type,fetch:!0,filters:[{property:"ObjectID",operator:"=",value:root.get("ObjectID")}]};async.map([config],wsapiQuery,function(err,results){var obj=results[0][0];app.list.push(obj);var childRef=null;if(app.defined(obj.get("Tasks"))?childRef="Tasks":app.defined(obj.get("Children"))?childRef="Children":app.defined(obj.get("UserStories"))&&(childRef="UserStories"),app.isObject(childRef)){var config={reference:obj,type:childRef};async.map([config],app.readCollection,function(err,results){var children=results[0];async.map(children,app.createList,function(err,results){callback(null,results)})})}else callback(null,obj)})},parentRef:function(obj){return _.isObject(obj.get("Parent"))?{type:"Parent",ref:obj.get("Parent")._ref}:_.isObject(obj.get("WorkProduct"))?{type:"WorkProduct",ref:obj.get("WorkProduct")._ref}:_.isObject(obj.get("PortfolioItem"))?{type:"PortfolioItem",ref:obj.get("PortfolioItem")._ref}:null},loadModel:function(type,callback){Rally.data.ModelFactory.getModel({type:type,success:function(model){callback(null,model)}})},isObject:function(obj){return!_.isUndefined(obj)&&!_.isNull(obj)},defined:function(obj){return app.isObject(obj)&&obj.Count>0},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}});
                function getReleaseTimeBox(app){var timeboxScope=app.getContext().getTimeboxScope(),tbName=null;if(timeboxScope){var record=timeboxScope.getRecord();tbName=record.get("Name")}else tbName="";return tbName}function wsapiQuery(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}function snapshotQuery(config,callback){var storeConfig={find:config.find,fetch:config.fetch,hydrate:config.hydrate,autoLoad:!0,pageSize:1e4,limit:"Infinity",listeners:{scope:this,load:function(store,snapshots,success){console.log("snapshots:",snapshots.length),callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)}function pointsUnitType(type){return"Points"==type}

            Rally.launchApp('CustomApp', {
                name:"portfolio-item-copy",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
